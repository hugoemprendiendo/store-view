
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda ---

    // Devuelve verdadero si el usuario ha iniciado sesión.
    function isSignedIn() {
      return request.auth != null;
    }

    // Devuelve verdadero si el ID del usuario de la solicitud coincide con el ID del documento que se está accediendo.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Obtiene el documento del perfil del usuario que realiza la solicitud.
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Comprueba si el documento del perfil del usuario existe.
    function userProfileExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Devuelve verdadero si el usuario es un 'superadmin'.
    function isSuperAdmin() {
      // Para que un usuario sea superadmin debe existir su perfil y tener el rol asignado
      return isSignedIn() && userProfileExists() && getUserProfile().data.role == 'superadmin';
    }

    // Devuelve verdadero si un usuario está asignado a una sucursal específica.
    // Un superadmin siempre tiene acceso.
    function isAssignedToBranch(branchId) {
      if (isSuperAdmin()) {
        return true;
      }
      if (!isSignedIn() || !userProfileExists()) {
        return false;
      }
      let userProfile = getUserProfile();
      // Verifica que el campo 'assignedBranches' exista, sea un mapa, y contenga el branchId como una clave con valor 'true'.
      return 'assignedBranches' in userProfile.data &&
             userProfile.data.assignedBranches is map &&
             branchId in userProfile.data.assignedBranches &&
             userProfile.data.assignedBranches[branchId] == true;
    }

    // --- Reglas por Colección ---

    // Colección de perfiles de usuario.
    match /users/{userId} {
      allow get, update: if isOwner(userId) || isSuperAdmin();
      allow list: if isSuperAdmin();
      // Un usuario puede crear su propio perfil.
      allow create: if isOwner(userId);
      allow delete: if false; // Nadie puede borrar perfiles de usuario directamente.
    }

    // Colección de sucursales.
    match /branches/{branchId} {
      // Permite leer una sucursal si el usuario está asignado a ella.
      allow get: if isAssignedToBranch(branchId);
      // Solo los superadmins pueden listar todas las sucursales. La app no permite esto para usuarios normales.
      allow list: if isSuperAdmin();
      // Solo los superadmins pueden crear, actualizar o borrar sucursales.
      allow create, update, delete: if isSuperAdmin();
    }

    // Colección de incidencias.
    match /incidents/{incidentId} {
      // PERMITE LA LECTURA (get, list) si se cumple una de dos condiciones:
      // 1. El usuario es un superadmin.
      // 2. El usuario está asignado a la sucursal de la incidencia (resource.data.branchId).
      // Esta regla es CLAVE para que las consultas `where('branchId', 'in', ...)` de la app funcionen,
      // ya que Firestore la evalúa para CADA DOCUMENTO que la consulta intenta devolver.
      allow read: if isSuperAdmin() || isAssignedToBranch(resource.data.branchId);

      // Permite la ESCRITURA (crear/actualizar/borrar) si se cumple una de dos condiciones:
      // 1. El usuario es un superadmin.
      // 2. Para crear, el usuario debe estar asignado a la sucursal del nuevo incidente.
      // 3. Para actualizar o borrar, el usuario debe estar asignado a la sucursal del incidente existente.
      allow write: if isSuperAdmin() ||
                     (request.method == 'create' && isAssignedToBranch(request.resource.data.branchId)) ||
                     (request.method == 'update' && isAssignedToBranch(resource.data.branchId)) ||
                     (request.method == 'delete' && isAssignedToBranch(resource.data.branchId));
    }

    // Colecciones de configuración (categorías, prioridades, estados).
    match /incident_categories/{categoryId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin();
    }

    match /incident_priorities/{priorityId} {
       allow read: if isSignedIn();
       allow write: if isSuperAdmin();
    }

    match /incident_statuses/{statusId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin();
    }
  }
}
